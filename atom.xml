<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>qzwlecr&#39;s Blog</title>
  <subtitle>一个辣鸡选手的自娱自乐</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://qzwlecr.github.io/"/>
  <updated>2018-01-15T19:05:14.576Z</updated>
  <id>http://qzwlecr.github.io/</id>
  
  <author>
    <name>qzwlecr</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2017 &amp;&amp; 2018</title>
    <link href="http://qzwlecr.github.io/2018/01/04/2017and2018/"/>
    <id>http://qzwlecr.github.io/2018/01/04/2017and2018/</id>
    <published>2018-01-04T14:29:29.000Z</published>
    <updated>2018-01-15T19:05:14.576Z</updated>
    
    <content type="html"><![CDATA[<p>2017，在珞瑜路1037号森林度过的完整的一年，一时竟不知道从何说起。</p>
<a id="more"></a>
<ul>
<li>1月。参加了团队的冬令营，读了《CS：APP》的前几章，做了Bomb-lab。写了一个简单的HTTP-server。重新安装了Archlinux。之后过了一个平平淡淡的年。</li>
<li>2月。在家里稍作修整，开学，继续读书，粗略地读完了《CS：APP》。</li>
<li>3月。加入学院的美团点评技术俱乐部，简单接触了后台的一些东西，没有兴趣遂放弃。开坑华为软件精英挑战赛，用网络流+遗传算法乱写一通，因为个人原因放弃。做了一个51单片机的PWM生成器，算是入门。告别单身。</li>
<li>4月5月。读了《C++ Primer》的大部分，《计算机网络》的大部分，学习TCP/IP。玩遍武汉，咸鱼无比。在武大和华科参加ACM校赛，去杭州参加高校天梯程序设计竞赛。退ACM队，安心写想写的东西。</li>
<li>6月。作为网络维护人员之一参加了Unique Hackday。在老学长的安利下开始学习分布式系统，读了一些paper，开始MIT 6.824的Lab。开始学习Go语言。</li>
<li>7月。参加了团队的夏令营，负责组内招新，继续MIT 6.824的Lab，看paper。去上海参加了Hack.init()，做了一个智能硬件，Tensorflow、Flask、Python，从入门到放弃。</li>
<li>8月。团队内部Hackweek，实现了一个可扩展可移植的代理。了解了一些前端内容。学习了《汇编语言》。</li>
<li>9月。负责组内秋季招新和团队熬夜测试。研究并写出很多很有意思的脚本供自己使用。重构代理。开始阅读《分布式系统概念与设计》。</li>
<li>10月。恢复单身。阅读了《分布式系统概念与设计》的大部分内容。了解docker技术并尝试用于特定系统下的GUI程序。去福州参观CNCC 2017。</li>
<li>11月。开坑全国高校云计算比赛的技能赛和命题赛，开始学习Scala，入门Spark，了解数据挖掘。阅读《大数据日知录》和一些经典paper。</li>
<li>12月。申请集群权限，继续深入Spark平台，处理云计算比赛的初赛提交。开始写一个分布式存储系统。</li>
</ul>
<p>这一年感觉是我长这么大学东西最多的一年，或者说是进步最大的一年，尽管进步之后仍然不尽如人意，但是我应该不再是去年的那个卑微的萌新了吧。</p>
<p>有关技术，除了学了一些分布式的东西，更多的是尝试接触底层，在已有的算法和数据结构的基础上尝试踏进网络、操作系统等方向的大门。但是令人遗憾的是我的C/C++并没有进步，停留在垃圾代码的水平，以及，我的算法退步很大，甚至面对一些基础问题都没有十足的把握，这些也是我应当要努力掌握的点。</p>
<p>有关生活，经历了一段感情，享受了那段时间的咸鱼生活，现在想来还是充满了感动。也开始认真思考自己的出路，希望能自己拯救自己。</p>
<p>So，2018，给自己的TODO LIST：</p>
<ul>
<li>找一份实习 || 参加GSoC || 进一个很棒的实验室，丰富简历的同时体验一点不同的生活。</li>
<li>继续学习分布式，看完MIT 6.824所有的参考论文。</li>
<li>至少读6本书，至少在炖的有《量化方法》《现代操作系统》《…》（怀疑人生）。</li>
<li>造一些轮子，丰富自己的Github。</li>
<li>如果有机会的话还是希望能有一段时机恰当的感情，这次应该会拼尽全力了吧。</li>
</ul>
<blockquote>
<p>如果你觉得生活很艰难，是因为你在拔一个大萝卜。</p>
</blockquote>
<p>2018，希望能遇到更好的自己。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;2017，在珞瑜路1037号森林度过的完整的一年，一时竟不知道从何说起。&lt;/p&gt;
    
    </summary>
    
    
      <category term="总结" scheme="http://qzwlecr.github.io/tags/%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>Spark中分区数量导致的Shuffle过程的OOM问题解决方案</title>
    <link href="http://qzwlecr.github.io/2017/12/06/Spark%E4%B8%AD%E5%88%86%E5%8C%BA%E6%95%B0%E9%87%8F%E5%AF%BC%E8%87%B4%E7%9A%84Shuffle%E8%BF%87%E7%A8%8B%E7%9A%84OOM%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    <id>http://qzwlecr.github.io/2017/12/06/Spark中分区数量导致的Shuffle过程的OOM问题解决方案/</id>
    <published>2017-12-06T13:29:57.000Z</published>
    <updated>2017-12-06T14:36:42.807Z</updated>
    
    <content type="html"><![CDATA[<p>在参加全国高校云计算应用创新大赛的过程中，我实现了分布式FP-Growth算法，但是在运行过程中一直出现OOM的问题，求助StackOverFlow无解后，我对这个问题进行了探究，发现其原因，解决方案如下。</p>
<a id="more"></a>
<p>首先需要明确<code>Spark</code>的运行机制。<code>Spark</code>的<code>RDD</code>可以根据需要被分成多个区，称为<code>partition</code>，这些区被分布在多个<code>Spark</code>节点上，分区之间交换数据只能通过网络通信的方式。当分区的数据排布无法满足需要执行的函数要求时，比如<code>reduceByKey</code>等，数据会进行重新排布，这个过程称为<code>Shuffle</code>。</p>
<p>在<code>Shuffle</code>的过程中，可能会出现<code>Out Of Memory</code>的问题，但是这不是因为<code>RDD</code>无法加载到内存，因为根据<code>Spark</code>的日志来看，每个节点仍有20G的剩余内存，排除这一问题，我查看了<code>Spark</code>的官方文档，<code>Shuffle</code>操作为了完成分组会为每一个任务创建哈希表，在这一过程中哈希表可能会非常大，导致<code>JVM</code>报错，这也和我们所观察到的函数调用栈一致。</p>
<p>因此，为了解决这一问题，除了改进分区方式，只能通过增加并行度的方式，即增加分区数量，使每个分区的数据量非常小。</p>
<p>这里存在一个可能会降低运行效率的问题，即并行度超出CPU实际核数，但是<code>Spark</code>事实上可以非常有效地支持段时间任务，它会通过复用<code>JVM</code>的方式减小任务启动的消耗，在本题中此时间可以忽略不计，因此该问题不存在。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在参加全国高校云计算应用创新大赛的过程中，我实现了分布式FP-Growth算法，但是在运行过程中一直出现OOM的问题，求助StackOverFlow无解后，我对这个问题进行了探究，发现其原因，解决方案如下。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spark" scheme="http://qzwlecr.github.io/tags/Spark/"/>
    
      <category term="云计算" scheme="http://qzwlecr.github.io/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
      <category term="调优" scheme="http://qzwlecr.github.io/tags/%E8%B0%83%E4%BC%98/"/>
    
  </entry>
  
  <entry>
    <title>Go语言net包需要注意的若干问题</title>
    <link href="http://qzwlecr.github.io/2017/10/31/Go%E8%AF%AD%E8%A8%80net%E5%8C%85%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E8%8B%A5%E5%B9%B2%E9%97%AE%E9%A2%98/"/>
    <id>http://qzwlecr.github.io/2017/10/31/Go语言net包需要注意的若干问题/</id>
    <published>2017-10-31T11:40:51.000Z</published>
    <updated>2017-11-01T14:42:52.705Z</updated>
    
    <content type="html"><![CDATA[<p>暑假开始和朋友一起实现了一套代理服务器和客户端，支持用户自定义加密细节。服务器由Go写成，客户端由C++写成，用户自定义模块为C语言的动态链接库。</p>
<p>最近加入了一些新功能，对代码进行了重构，在这个过程中遇到了一些使用net包进行TCP网络通信的问题，列举如下。</p>
<a id="more"></a>
<h2 id="net-Conn-的阻塞问题"><a href="#net-Conn-的阻塞问题" class="headerlink" title="net.Conn 的阻塞问题"></a><code>net.Conn</code> 的阻塞问题</h2><p>目前主流的Web Server主要是采用IO多路复用+非阻塞的架构，但是这给使用者带来了比较大的复杂度，因此Go语言将其集成在Runtime中，使<code>socket</code>在用户层的行为与阻塞相同。事实上，这种阻塞是Go Runtime中的<code>netpoller</code>模拟出来的，它截获了底层系统调用的返回值，并通过<code>goroutine</code>调度使非阻塞表现为阻塞。</p>
<p>此处应注意，Go中的<code>socket</code>与C语言的<code>socket</code>的不同之处。</p>
<h2 id="net-Conn-的读写问题"><a href="#net-Conn-的读写问题" class="headerlink" title="net.Conn 的读写问题"></a><code>net.Conn</code> 的读写问题</h2><p>首先要注意到，Read方法和Write方法并不阻塞到读写完指定的字符个数，而是尝试读写后直接返回，因此，尤其对于Read方法，没有读完指定的字符也会正常返回，这时应该使用循环的方式，每次尝试把没读到的字符读完。一定要记得处理已读到的字符时使用Read的返回值，即不一定读满。（两次SSL握手失败都是这个原因）</p>
<p>还有另外的方法，可以用它所继承的<code>io.ReadFull</code>来处理，<code>io.ReadFull</code>内封装了相关的处理，直到读完指定的字符才会返回。</p>
<h2 id="channel的关闭导致的内存泄漏问题"><a href="#channel的关闭导致的内存泄漏问题" class="headerlink" title="channel的关闭导致的内存泄漏问题"></a><code>channel</code>的关闭导致的内存泄漏问题</h2><p>在读写时，为了保证连接的正常关闭，我使用一个<code>channel</code>表示连接是否为关闭状态，只有当读写都关闭时<code>channel</code>才会关闭，可是这时由于向对方已经关闭的<code>socket</code> <code>Write</code>并不会产生错误，导致很多网络连接最终无法关闭，迫于无奈我把代理的四个方向合并为两个方向，使双向的连接都正常关闭。</p>
<p>要知道，<code>channel</code>也是会占用内存的，如果未关闭的个数太多，会产生严重的内存泄漏，这里我不优雅地使用超时来解决，后期可以以心跳包的形式解决。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;暑假开始和朋友一起实现了一套代理服务器和客户端，支持用户自定义加密细节。服务器由Go写成，客户端由C++写成，用户自定义模块为C语言的动态链接库。&lt;/p&gt;
&lt;p&gt;最近加入了一些新功能，对代码进行了重构，在这个过程中遇到了一些使用net包进行TCP网络通信的问题，列举如下。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Go" scheme="http://qzwlecr.github.io/tags/Go/"/>
    
      <category term="网络" scheme="http://qzwlecr.github.io/tags/%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>在Docker中运行网易云音乐</title>
    <link href="http://qzwlecr.github.io/2017/10/30/%E5%9C%A8Docker%E4%B8%AD%E8%BF%90%E8%A1%8C%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90/"/>
    <id>http://qzwlecr.github.io/2017/10/30/在Docker中运行网易云音乐/</id>
    <published>2017-10-30T10:56:08.000Z</published>
    <updated>2017-11-02T17:02:12.100Z</updated>
    
    <content type="html"><![CDATA[<p>在Archlinux上的网易云音乐成功以白屏、歌词不显示、右键菜单崩溃宣告离开我的电脑之后，我发现Docker可以运行GUI程序，就用Docker成功运行了网易云音乐，造福一波Arch上的网易云音乐用户XD。</p>
<a id="more"></a>
<h2 id="在Docker中运行GUI程序"><a href="#在Docker中运行GUI程序" class="headerlink" title="在Docker中运行GUI程序"></a>在Docker中运行GUI程序</h2><h3 id="显示问题"><a href="#显示问题" class="headerlink" title="显示问题"></a>显示问题</h3><p>目前，很大一部分Arch用户都仍使用X作为Window System（当然Wayland也已经占据很大一部分市场份额），我暂时也是其使用者之一，因此只对X做了一些简单的适配，而且网易云音乐是可以被我们一定程度上信赖的软件，安全问题未考虑在内。</p>
<p>众所周知，X Server与X Client通信的最简单的方式，是使用Unix-domain Socket，X Server把它的Socket放在<code>/tmp/.X11-unix</code>下，以文件的形式存储。因此，首先要把该目录挂载到容器中。</p>
<p>参数为：<code>-v /tmp/.X11-unix:/tmp/.X11-unix</code></p>
<p>同时，为了使X Client能正常的找到X Server， 环境变量<code>$DISPLAY</code>也必须传入容器中。这个变量是X Window System 很魔幻的一个Feature，它的值为<code>hostname:sequence_number.screen_number</code>，通过它X Client才能够知道如何把X Network Traffic重定向到本地的X Server。</p>
<p>参数为：<code>-e DISPLAY</code></p>
<p>另外，为了使Docker容器中的用户能够正常访问，还需要<a href="https://wiki.archlinux.org/index.php/Xhost" target="_blank" rel="external">Xhost</a>提供本地的访问权限（这也是最终唯一的额外依赖包<a href="https://www.archlinux.org/packages/?name=xorg-xhost" target="_blank" rel="external">xorg-xhost</a>的来源）。</p>
<p>命令为：<code>xhost + local:</code></p>
<p>这样就可以正常地显示啦w。</p>
<h3 id="声音问题"><a href="#声音问题" class="headerlink" title="声音问题"></a>声音问题</h3><p>声音问题同理可得，通过查阅PulseAudio的文档，可以知道<code>$XDG_RUNTIME_DIR/pulse/native</code>需要挂载进容器中，而变量<code>$PULSE_SERVER</code>也必须传入容器中，原理不再赘述。为了使声音设备能够被正常访问，还需要把<code>/dev/snd</code>挂载进容器中。</p>
<p>参数如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-v $&#123;XDG_RUNTIME_DIR&#125;/pulse/native:$&#123;XDG_RUNTIME_DIR&#125;/pulse/native \</div><div class="line">-e PULSE_SERVER=unix:$&#123;XDG_RUNTIME_DIR&#125;/pulse/native \</div><div class="line">--device /dev/snd</div></pre></td></tr></table></figure></p>
<h3 id="网络问题"><a href="#网络问题" class="headerlink" title="网络问题"></a>网络问题</h3><p>由于容器需要与外部共享网络，这里使用Docker的参数<code>--ipc host</code>就可以完成。</p>
<h3 id="指针问题"><a href="#指针问题" class="headerlink" title="指针问题"></a>指针问题</h3><p>XOrg默认的指针难看得令人发指= =！为了解决指针的问题，需要将用户的<code>/usr/share/icon</code>挂载到容器的相同位置，这样就可以使Docker中的GUI程序与系统环境共用鼠标指针。</p>
<p>参数为：<code>-v /usr/share/icons:/usr/share/icons:ro</code></p>
<h2 id="网易云音乐的依赖解决"><a href="#网易云音乐的依赖解决" class="headerlink" title="网易云音乐的依赖解决"></a>网易云音乐的依赖解决</h2><p>选用Ubuntu 16.04 作为Docker 的 Base。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">FROM docker.io/ubuntu:16.04</div></pre></td></tr></table></figure>
<p>查看AUR中网易云音乐的依赖，并没有发现任何有用的信息，猜想着安了一个文泉驿的中文字体，然后把环境变量<code>LANG</code>设置成了中文，依然无法正常运行。</p>
<p>对报错信息稍微搜索一下，发现使用D-Bus进行一些奇怪的通信，于是安装了<code>dbus-x11</code>和<code>packagekit</code>，又发现提示音导致的一些Warning，就安装了<code>libcanberra</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt-get install -y --no-install-recommends wget dbus-x11 libcanberra-gtk-module fonts-wqy-zenhei packagekit-gtk3-module</div></pre></td></tr></table></figure>
<p>其他的过程毫无悬念，按照正常<code>.deb</code>包安装即可2333</p>
<h2 id="在Docker中运行网易云音乐"><a href="#在Docker中运行网易云音乐" class="headerlink" title="在Docker中运行网易云音乐"></a>在Docker中运行网易云音乐</h2><p>这是第一次完全靠自己手写Dockerfile，之前都是对着各种现成的Dockerfile Copy&amp;Paste，踩了一点坑QAQ。</p>
<ul>
<li><code>apt-get install</code>一定要使用<code>--no-install-recommends</code>，这样可以大大减小最终体积。</li>
<li>在下载完一个不再使用的文件或者软件包之后一定要在同一个<code>RUN</code>中把它移除掉，避免无谓的占用。</li>
<li>大部分情况下<code>RUN</code>可以并在同一条命令中完成，避免多余的commit占用体积。</li>
<li><code>CMD</code>命令<code>[&quot;command&quot;,&quot;args&quot;...]</code>是非常实用的简化书写的方法，在很多情况下优于<code>ENTRYPOINT</code>。</li>
</ul>
<p>此外，配置文件夹、缓存文件夹和默认音乐文件夹也都挂载到相同位置。</p>
<p>参数为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-v $HOME/.config:/root/.config \</div><div class="line">-v $HOME/.cache:/root/.cache \</div><div class="line">-v $HOME/Music:/root/Music</div></pre></td></tr></table></figure>
<h2 id="PKGBUILD打包上传"><a href="#PKGBUILD打包上传" class="headerlink" title="PKGBUILD打包上传"></a>PKGBUILD打包上传</h2><p><code>PKGBUILD</code>并不难写，有问题的是<code>.install</code>脚本，以前没有接触过所以不怎么了解。</p>
<ul>
<li><code>.install</code>脚本中不能出现任何和用户交互的命令，踩坑owo。</li>
<li><code>PKGBUILD</code>中的函数是在<code>fakeroot</code>下运行的，但是<code>.install</code>并不是，可以理解为是在真实<code>sudo</code>环境下运行的脚本，所以什么都能做到w。</li>
<li>要想使普通用户正常使用Docker，需要将其加入<code>docker</code>用户组中，但是刷新用户组只能通过重新登录来解决，为了方便起见，甩给安装者一个Warning，并在之后的启动脚本中加入<code>sg</code>，避免了安装后的重启。</li>
</ul>
<h2 id="大胜利"><a href="#大胜利" class="headerlink" title="大胜利"></a>大胜利</h2><p>然后就结束了，体验成功++，欢迎各位食用和提issue，<code>netease-cloud-music-docker-version</code>已加入AUR中。</p>
<p><a href="https://github.com/qzwlecr/netease-cloud-music-docker-version" target="_blank" rel="external">Github仓库地址</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在Archlinux上的网易云音乐成功以白屏、歌词不显示、右键菜单崩溃宣告离开我的电脑之后，我发现Docker可以运行GUI程序，就用Docker成功运行了网易云音乐，造福一波Arch上的网易云音乐用户XD。&lt;/p&gt;
    
    </summary>
    
    
      <category term="docker" scheme="http://qzwlecr.github.io/tags/docker/"/>
    
      <category term="Archlinux" scheme="http://qzwlecr.github.io/tags/Archlinux/"/>
    
  </entry>
  
  <entry>
    <title>UniqueStudio 夏令营小结</title>
    <link href="http://qzwlecr.github.io/2017/08/07/UniqueStudio-%E5%A4%8F%E4%BB%A4%E8%90%A5%E5%B0%8F%E7%BB%93/"/>
    <id>http://qzwlecr.github.io/2017/08/07/UniqueStudio-夏令营小结/</id>
    <published>2017-08-07T06:31:23.000Z</published>
    <updated>2018-01-15T19:17:54.099Z</updated>
    
    <content type="html"><![CDATA[<p>小小地总结一下过去的夏令营，假装记录下学的东西。</p>
<a id="more"></a>
<h2 id="分布式学习"><a href="#分布式学习" class="headerlink" title="分布式学习"></a>分布式学习</h2><p>本来这个假期是想好好肝分布式的基础内容的，然而并不是那么有动力，时间精力也并没有太花在这上面。简单地说，认真读完了MapReduce、Google File System、Raft、Fault-Tolerant Virtual Machine以及ZooKeeper的论文，并补习了相关的一些基础知识；按照MIT Lab 6.824的要求，做完了Lab 2、Lab 3A，并通过了全部Test。想来的话确实是收获了很多以前没仔细看过、只是了解而已的知识，还自己探究了很多细节上的问题，大概可以说收获了分布式的思想方法吧。</p>
<p>读论文的话没什么问题，按着MIT 6.824 Schedule的Preparation读就是了，不会就查；反倒是Lab耗费了大量的时间，单单一个Lab 2，Debug时间大约在一周左右，感觉写的测试代码比最终代码还要长很多，陷入无限的绝望之中。两个Lab里踩的几个坑大概有：RPC不一定按照发送的时间顺序接收、加锁不注意的话很容易出现race condition、测试使用更大的election timeout会更容易选举成功、向ApplyCh写入时异步会出现顺序错乱、RPC发送结构体必须先注册再发送、interface要随时注意转换的情况。惨惨惨qaq…</p>
<h2 id="镜像源部署"><a href="#镜像源部署" class="headerlink" title="镜像源部署"></a>镜像源部署</h2><p>莫名其妙接了一口锅，好好配置一下以前的脚本保证能用的就好，结果后来基本都是@Recolic重写了一套脚本在搞，我就变成了打杂选手233</p>
<p>首先是rsync同步大文件的问题，加上–size-only参数情况就会好很多，主要是由于大文件的校验和在远端传输有一些缓慢造成的；其次是同步状态的更新问题，本来是学长写的渲染引擎，后来和前端交流了一下改成jinja2，再后来想了想又把它改成了PHP，本地读取文件状态。问题不算太多，还算比较顺利了。</p>
<p>欢迎来玩：<a href="http://mirrors.hustunique.com" target="_blank" rel="external">mirrors.hustunique.com</a></p>
<h2 id="C语言课设"><a href="#C语言课设" class="headerlink" title="C语言课设"></a>C语言课设</h2><p>一个超级垃圾的学生作业管理系统，却强行搞了一个前后端分离的架构复习了一下网络通信和多线程，现在只写了一个开头，打算回家之后好好写完，顺便摸一波鱼，没什么难度就不说了。</p>
<h2 id="Hack-Init"><a href="#Hack-Init" class="headerlink" title="Hack.Init()"></a>Hack.Init()</h2><p>中间的时候跑去上海参加了一下Hack.Init()，结识了来自各地的三个小哥，入手了一下Flask和Tensorflow做了一次API Caller，可以说是非常绝望了。我们做了一个智能硬件，用机器学习识别后方汽车和行驶方向，提醒驾驶员防止疲劳驾驶。可是最后因为串口通信和识别函数写炸的问题，并没有拿到奖，不过经历还是蛮开心的。就当去上海旅游了一趟。</p>
<h2 id="Hackweek"><a href="#Hackweek" class="headerlink" title="Hackweek"></a>Hackweek</h2><p>由于某些不可言说的问题，实现了一套支持用户自定义代理认证和细节填充的软件，顺利拿到了内部Hackweek第一名，巨开心www服务端使用Go语言、客户端使用C++进行开发，方便跨平台移植，以后shadow*ocks没有了就靠自己写的了2333</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>一个多月过的可以说是很充实了，学了也算是不少东西，不过不会的东西还是太多了，和dalao差距有点大，加油加油www</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;小小地总结一下过去的夏令营，假装记录下学的东西。&lt;/p&gt;
    
    </summary>
    
    
      <category term="总结" scheme="http://qzwlecr.github.io/tags/%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>MapReduce：大规模集群上的简单数据处理方式 &amp;&amp; MIT 6.824 Lab 1</title>
    <link href="http://qzwlecr.github.io/2017/06/12/MapReduce-%E5%A4%A7%E8%A7%84%E6%A8%A1%E9%9B%86%E7%BE%A4%E4%B8%8A%E7%9A%84%E7%AE%80%E5%8D%95%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F-MIT-6.824-Lab-1/"/>
    <id>http://qzwlecr.github.io/2017/06/12/MapReduce-大规模集群上的简单数据处理方式-MIT-6.824-Lab-1/</id>
    <published>2017-06-12T03:36:28.000Z</published>
    <updated>2017-07-20T05:15:04.180Z</updated>
    
    <content type="html"><![CDATA[<p>MapReduce是Google公司的Jeffrey和Sanjay提出的一个编程模型，主要用于大规模数据集的并行运算。它吸收了函数式编程语言中的Map和Reduce，通过Map处理原始键值对生成中间键值对，通过Reduce合并相同中间键对应的值。这一特性符合很多现实生活中的场景。</p>
<p>这种编程模型下的程序可以并行化地在大规模集群上运行，而在这一过程中用户却不需考虑输入数据的划分、程序的运行安排、节点故障和机器间通信，只需完成对数据的处理和合并。</p>
<p>我阅读了MapReduce的论文，并完成了MIT 6.824的第一个Lab，对其有了更深的了解。</p>
<a id="more"></a>
<h2 id="过程总览"><a href="#过程总览" class="headerlink" title="过程总览"></a>过程总览</h2><p><img src="/images/Map-Reduce/overview.png" alt="overview"></p>
<ol>
<li>用户程序调用MapReduce库，先把输入文件划分为M份（M可由用户指定），每一份通常为16MB到64MB，如图左方所示分成了split0~4，然后将用户程序fork到集群内其它机器上。 </li>
<li>用户程序副本中有一个称为master，其余称为worker，master负责调度，为空闲worker分配任务（Map任务或者Reduce任务）。 </li>
<li>Map worker开始读取对应的输入数据，它们从输入数据中抽取出Key-Value Pair，每一个都作为参数传递给Map函数，Map函数产生的中间Key-Value Pair被缓存在内存中。 </li>
<li>缓存在内存中的中间Key-Value Pair会被定期写入本地磁盘，而且被分为R个区（R可由用户指定），这些中间Key-Value Pair的位置会被通报给master，master负责将信息通报给Reduce worker。 </li>
<li>master通报Reduce worker它负责的分区的位置，当Reduce worker把所有它负责的中间数据都读过来后，先对它们进行排序，使得相同Key的数据聚集在一起。若内部排序无法满足要求，则使用外部排序。</li>
<li>Reduce worker遍历排序后的中间Key-Value Pair，对于每个唯一的Key，都将Key与关联的Value传递给Reduce函数，Reduce函数产生的输出会添加到对应分区的输出文件中。</li>
<li>当所有的Map和Reduce作业都完成了，master唤醒用户程序，MapReduce函数返回。</li>
<li>MapReduce共产生R个输出文件（对应R个Reduce任务），用作分布式存储系统或其他分布式应用中。</li>
</ol>
<h2 id="容错机制"><a href="#容错机制" class="headerlink" title="容错机制"></a>容错机制</h2><h3 id="Worker错误"><a href="#Worker错误" class="headerlink" title="Worker错误"></a>Worker错误</h3><p>当master定期发送的ping在某一时间段内没有到达某worker时，将该worker置为失效：</p>
<ol>
<li>若该worker任务为Map，则将该worker的所有任务置为空闲，并在分配任务时将其安排给其他的worker；当一个接替其任务的Map worker完成时，向所有Reduce worker发送通知，任何还未从失效worker读取数据的Reduce worker将从新worker读取数据；</li>
<li>若该worker任务为Reduce，则将该worker的正在运行的任务置为空闲，并在分配任务时将其安排给其他的worker；已完成的任务不做调整。</li>
</ol>
<h3 id="Master错误"><a href="#Master错误" class="headerlink" title="Master错误"></a>Master错误</h3><p>由于只有一个master，因此在发生错误时会返回主程序，由客户端确认状态。</p>
<h3 id="容错性保证"><a href="#容错性保证" class="headerlink" title="容错性保证"></a>容错性保证</h3><p>当用户提供的Map和Reduce操作对输入为确定函数时，分布式实现的输出与顺序输出保持一致，这种一致性是通过对Map和Reduce操作的输出进行原子提交来保证的，即依赖于文件系统的原子性操作。</p>
<p>当用户提供的Map和Reduce操作对输入为不确定函数时，最终输出本就不确定，也可以一定程度上保证一致性。</p>
<h2 id="优化技巧"><a href="#优化技巧" class="headerlink" title="优化技巧"></a>优化技巧</h2><h3 id="存储位置"><a href="#存储位置" class="headerlink" title="存储位置"></a>存储位置</h3><p>利用GFS，对数据产生多个备份，在调用任务时，尽量从本地读取数据，避免网络调用占用带宽，降低速度。</p>
<h3 id="片段分配"><a href="#片段分配" class="headerlink" title="片段分配"></a>片段分配</h3><p>为了保证速度和准确性，需要有效分配片段，通常限制M，使每一份为16MB到64MB，而R为worker机器数量的小倍数。</p>
<h3 id="备用任务"><a href="#备用任务" class="headerlink" title="备用任务"></a>备用任务</h3><p>当一个MapReduce将要完成的时候，master启用备用进程，来执行还在执行的任务，以减少落后worker造成的影响。</p>
<h2 id="Lab-解析"><a href="#Lab-解析" class="headerlink" title="Lab 解析"></a>Lab 解析</h2><p>本Lab要求你补全一个基本完成的MapReduce程序，共有5个Part，其中Part I、II为Sequential MapReduce，Part III、IV为Sequential MapReduce，Part V为附加任务。程序整体难度不大，主要的难点在于熟悉Go语言。</p>
<h3 id="Part-I-Map-Reduce-input-and-output"><a href="#Part-I-Map-Reduce-input-and-output" class="headerlink" title="Part I: Map/Reduce input and output"></a>Part I: Map/Reduce input and output</h3><p>要求实现两个模板化的函数<code>doMap</code>和<code>doReduce</code>，按照注释所给步骤以及论文相关步骤编写即可。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doMap</span><span class="params">(</span></span></div><div class="line">   jobName <span class="keyword">string</span>, </div><div class="line">   mapTaskNumber <span class="keyword">int</span>, </div><div class="line">   inFile <span class="keyword">string</span>,</div><div class="line">   nReduce <span class="keyword">int</span>, </div><div class="line">   mapF <span class="keyword">func</span>(file <span class="keyword">string</span>, contents <span class="keyword">string</span>) []<span class="title">KeyValue</span>,</div><div class="line">) &#123;</div><div class="line">   inContent, err := ioutil.ReadFile(inFile)</div><div class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">      fmt.Fprintln(os.Stderr, err)</div><div class="line">      <span class="keyword">return</span></div><div class="line">   &#125;</div><div class="line">   keyValue := mapF(inFile, <span class="keyword">string</span>(inContent))</div><div class="line">   partitions := <span class="built_in">make</span>([]*json.Encoder, nReduce, nReduce)</div><div class="line">   <span class="keyword">for</span> id := <span class="number">0</span>; id &lt; nReduce; id++ &#123;</div><div class="line">      handler, err := os.OpenFile(reduceName(jobName, mapTaskNumber, id), os.O_CREATE|os.O_WRONLY, <span class="number">0644</span>)</div><div class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">         fmt.Fprintln(os.Stderr, err)</div><div class="line">         <span class="keyword">return</span></div><div class="line">      &#125;</div><div class="line">      <span class="keyword">defer</span> handler.Close()</div><div class="line">      partitions[id] = json.NewEncoder(handler)</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> _, keyValueSingle := <span class="keyword">range</span> keyValue &#123;</div><div class="line">      _ = partitions[ihash(keyValueSingle.Key)%nReduce].Encode(&amp;keyValueSingle)</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doReduce</span><span class="params">(</span></span></div><div class="line">   jobName <span class="keyword">string</span>, </div><div class="line">   reduceTaskNumber <span class="keyword">int</span>, </div><div class="line">   outFile <span class="keyword">string</span>, </div><div class="line">   nMap <span class="keyword">int</span>, </div><div class="line">   reduceF <span class="keyword">func</span>(key <span class="keyword">string</span>, values []<span class="keyword">string</span>) <span class="title">string</span>,</div><div class="line">) &#123;</div><div class="line">   midContentBuf := bytes.NewBuffer(<span class="literal">nil</span>)</div><div class="line">   <span class="keyword">for</span> maps := <span class="number">0</span>; maps &lt; nMap; maps++ &#123;</div><div class="line">      f, err := os.Open(reduceName(jobName, maps, reduceTaskNumber))</div><div class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">         fmt.Fprintln(os.Stderr, err)</div><div class="line">         <span class="keyword">return</span></div><div class="line">      &#125;</div><div class="line">      io.Copy(midContentBuf, f)</div><div class="line">      f.Close()</div><div class="line">   &#125;</div><div class="line">   decoder := json.NewDecoder(bytes.NewReader(midContentBuf.Bytes()))</div><div class="line">   <span class="keyword">var</span> kv KeyValue</div><div class="line">   keyValueMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>)</div><div class="line">   <span class="keyword">for</span> &#123;</div><div class="line">      err := decoder.Decode(&amp;kv)</div><div class="line">      <span class="keyword">if</span> err == io.EOF &#123;</div><div class="line">         <span class="keyword">break</span></div><div class="line">      &#125;</div><div class="line">      keyValueMap[kv.Key] = <span class="built_in">append</span>(keyValueMap[kv.Key], kv.Value)</div><div class="line">   &#125;</div><div class="line">   keys := []<span class="keyword">string</span>&#123;&#125;</div><div class="line">   <span class="keyword">for</span> keyValueSingle := <span class="keyword">range</span> keyValueMap &#123;</div><div class="line">      keys = <span class="built_in">append</span>(keys, keyValueSingle)</div><div class="line">   &#125;</div><div class="line">   sort.Strings(keys)</div><div class="line">   answerFileName := mergeName(jobName, reduceTaskNumber)</div><div class="line">   answerFile, err := os.OpenFile(answerFileName, os.O_CREATE|os.O_WRONLY, <span class="number">0644</span>)</div><div class="line">   <span class="keyword">defer</span> answerFile.Close()</div><div class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">      fmt.Fprintln(os.Stderr, err)</div><div class="line">      <span class="keyword">return</span></div><div class="line">   &#125;</div><div class="line">   encoder := json.NewEncoder(answerFile)</div><div class="line">   <span class="keyword">for</span> _, key := <span class="keyword">range</span> keys &#123;</div><div class="line">      encoder.Encode(KeyValue&#123;key, reduceF(key, keyValueMap[key])&#125;)</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Part-II-Single-worker-word-count"><a href="#Part-II-Single-worker-word-count" class="headerlink" title="Part II: Single-worker word count"></a>Part II: Single-worker word count</h3><p>要求实现wordcount，闭着眼睛乱写可以通过测试。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapF</span><span class="params">(filename <span class="keyword">string</span>, contents <span class="keyword">string</span>)</span> []<span class="title">mapreduce</span>.<span class="title">KeyValue</span></span> &#123;</div><div class="line">   keyValues := <span class="built_in">make</span>([]mapreduce.KeyValue, <span class="number">0</span>, <span class="number">0</span>)</div><div class="line">   f := <span class="function"><span class="keyword">func</span><span class="params">(c <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">      <span class="keyword">return</span> !unicode.IsLetter(c)</div><div class="line">   &#125;</div><div class="line">   fields := strings.FieldsFunc(contents, f)</div><div class="line">   <span class="keyword">for</span> _, each := <span class="keyword">range</span> fields &#123;</div><div class="line">      keyValues = <span class="built_in">append</span>(keyValues, mapreduce.KeyValue&#123;each, <span class="string">""</span>&#125;)</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> keyValues</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">reduceF</span><span class="params">(key <span class="keyword">string</span>, values []<span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">   <span class="keyword">return</span> strconv.Itoa(<span class="built_in">len</span>(values))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Part-III-Distributing-MapReduce-tasks"><a href="#Part-III-Distributing-MapReduce-tasks" class="headerlink" title="Part III: Distributing MapReduce tasks"></a>Part III: Distributing MapReduce tasks</h3><p>要求实现给worker分配任务的<code>schedule</code>函数，worker地址是通过<code>registerChannel</code>获取的，在<code>schedule</code>中会启动n个<code>goroutine</code>，每个都从<code>registerChannel</code>中获取worker地址，然后进行<code>RPC</code>调用，成功后，再放回到<code>registerChannel</code>中。这里首次使用了<code>channel</code>和<code>goroutine</code>等Go语言的高级特性，需要好好学习。</p>
<h3 id="Part-IV-Handling-worker-failures"><a href="#Part-IV-Handling-worker-failures" class="headerlink" title="Part IV: Handling worker failures"></a>Part IV: Handling worker failures</h3><p>在Part 3的基础上，要求实现worker的容错机制，这里只需要简单地不把无法到达的worker加入<code>registerChannel</code>中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">schedule</span><span class="params">(jobName <span class="keyword">string</span>, mapFiles []<span class="keyword">string</span>, nReduce <span class="keyword">int</span>, phase jobPhase, registerChan <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">   <span class="keyword">var</span> ntasks <span class="keyword">int</span></div><div class="line">   <span class="keyword">var</span> n_other <span class="keyword">int</span> <span class="comment">// number of inputs (for reduce) or outputs (for map)</span></div><div class="line">   <span class="keyword">switch</span> phase &#123;</div><div class="line">   <span class="keyword">case</span> mapPhase:</div><div class="line">      ntasks = <span class="built_in">len</span>(mapFiles)</div><div class="line">      n_other = nReduce</div><div class="line">   <span class="keyword">case</span> reducePhase:</div><div class="line">      ntasks = nReduce</div><div class="line">      n_other = <span class="built_in">len</span>(mapFiles)</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   fmt.Printf(<span class="string">"Schedule: %v %v tasks (%d I/Os)\n"</span>, ntasks, phase, n_other)</div><div class="line"></div><div class="line">   <span class="keyword">var</span> waitGroup sync.WaitGroup</div><div class="line">   <span class="keyword">for</span> task := <span class="number">0</span>; task &lt; ntasks; task++ &#123;</div><div class="line">      waitGroup.Add(<span class="number">1</span>)</div><div class="line">      worker := &lt;-registerChan</div><div class="line">      <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(id <span class="keyword">int</span>, worker <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">         <span class="keyword">defer</span> waitGroup.Done()</div><div class="line">         args := DoTaskArgs&#123;jobName, mapFiles[id], phase, id, n_other&#125;</div><div class="line">         ok := call(worker, <span class="string">"Worker.DoTask"</span>, args, <span class="literal">nil</span>)</div><div class="line">         <span class="keyword">if</span> !ok &#123;</div><div class="line">            <span class="keyword">for</span> !ok &#123;</div><div class="line">               worker := &lt;-registerChan</div><div class="line">               ok = call(worker, <span class="string">"Worker.DoTask"</span>, args, <span class="literal">nil</span>)</div><div class="line">               <span class="keyword">if</span> ok &#123;</div><div class="line">                  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">                     registerChan &lt;- worker</div><div class="line">                  &#125;()</div><div class="line">                  <span class="keyword">break</span></div><div class="line">               &#125;</div><div class="line">            &#125;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">               registerChan &lt;- worker</div><div class="line">            &#125;()</div><div class="line">         &#125;</div><div class="line">      &#125;(task, worker)</div><div class="line">   &#125;</div><div class="line">   waitGroup.Wait()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Part-V-Inverted-index-generation-optional-for-extra-credit"><a href="#Part-V-Inverted-index-generation-optional-for-extra-credit" class="headerlink" title="Part V: Inverted index generation (optional for extra credit)"></a>Part V: Inverted index generation (optional for extra credit)</h3><p>要求实现一个倒排索引，难度不大。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapF</span><span class="params">(document <span class="keyword">string</span>, value <span class="keyword">string</span>)</span> <span class="params">(res []mapreduce.KeyValue)</span></span> &#123;</div><div class="line">   keyValues := <span class="built_in">make</span>([]mapreduce.KeyValue, <span class="number">0</span>, <span class="number">0</span>)</div><div class="line">   f := <span class="function"><span class="keyword">func</span><span class="params">(c <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">      <span class="keyword">return</span> !unicode.IsLetter(c)</div><div class="line">   &#125;</div><div class="line">   fields := strings.FieldsFunc(value, f)</div><div class="line">   sort.Strings(fields)</div><div class="line">   <span class="keyword">for</span> _, each := <span class="keyword">range</span> fields &#123;</div><div class="line">      keyValues = <span class="built_in">append</span>(keyValues, mapreduce.KeyValue&#123;each, document&#125;)</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> keyValues</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">reduceF</span><span class="params">(key <span class="keyword">string</span>, values []<span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">   uniq := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)</div><div class="line">   <span class="keyword">for</span> _, value := <span class="keyword">range</span> values &#123;</div><div class="line">      uniq[value] = <span class="number">1</span></div><div class="line">   &#125;</div><div class="line">   answer := strconv.Itoa(<span class="built_in">len</span>(uniq))</div><div class="line">   name := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(uniq))</div><div class="line">   <span class="keyword">for</span> key, _ := <span class="keyword">range</span> uniq &#123;</div><div class="line">      name = <span class="built_in">append</span>(name, key)</div><div class="line">   &#125;</div><div class="line">   answer += <span class="string">" "</span></div><div class="line">   sort.Strings(name)</div><div class="line">   answer += strings.Join(name, <span class="string">","</span>)</div><div class="line">   <span class="keyword">return</span> answer</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;MapReduce是Google公司的Jeffrey和Sanjay提出的一个编程模型，主要用于大规模数据集的并行运算。它吸收了函数式编程语言中的Map和Reduce，通过Map处理原始键值对生成中间键值对，通过Reduce合并相同中间键对应的值。这一特性符合很多现实生活中的场景。&lt;/p&gt;
&lt;p&gt;这种编程模型下的程序可以并行化地在大规模集群上运行，而在这一过程中用户却不需考虑输入数据的划分、程序的运行安排、节点故障和机器间通信，只需完成对数据的处理和合并。&lt;/p&gt;
&lt;p&gt;我阅读了MapReduce的论文，并完成了MIT 6.824的第一个Lab，对其有了更深的了解。&lt;/p&gt;
    
    </summary>
    
    
      <category term="分布式" scheme="http://qzwlecr.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
      <category term="Lab" scheme="http://qzwlecr.github.io/tags/Lab/"/>
    
  </entry>
  
  <entry>
    <title>Leetcode一句话题解</title>
    <link href="http://qzwlecr.github.io/2017/05/20/Leetcode%E4%B8%80%E5%8F%A5%E8%AF%9D%E9%A2%98%E8%A7%A3/"/>
    <id>http://qzwlecr.github.io/2017/05/20/Leetcode一句话题解/</id>
    <published>2017-05-20T05:48:57.000Z</published>
    <updated>2017-07-17T06:49:45.834Z</updated>
    
    <content type="html"><![CDATA[<p>最近无聊，刷了一批Leetcode水题，用简要题解记录一下做题过程，也小小帮助一下被坑所困的人。</p>
<a id="more"></a>
<h2 id="1-10"><a href="#1-10" class="headerlink" title="1~10"></a>1~10</h2><ol>
<li><p><a href="https://leetcode.com/problems/two-sum" target="_blank" rel="external">Two Sum</a></p>
<ol>
<li>$O(n^2)$：暴力枚举</li>
<li>$O(nlogn)$：排序+two-pointers或者map/set大法好</li>
<li>$O(n)$：哈希表</li>
</ol>
</li>
<li><p><a href="https://leetcode.com/problems/add-two-numbers" target="_blank" rel="external">Add Two Numbers</a></p>
<p>$O(n)$，边处理边进位，注意最后一位进位和链表为空的边界情况</p>
</li>
<li><p><a href="https://leetcode.com/problems/longest-substring-without-repeating-characters" target="_blank" rel="external">Longest Substring Without Repeating Characters</a></p>
<ol>
<li>$O(nlogn)$，滑动窗口，用一个set维护当前的字符集，如果新加入的字符以前出现过，抛弃左边重复的字符，所有字符有且仅有被遍历一遍</li>
<li>$O(n)$，把set换为哈希表</li>
</ol>
</li>
<li><p><a href="https://leetcode.com/problems/median-of-two-sorted-arrays" target="_blank" rel="external">Median of Two Sorted Arrays</a></p>
<p>$O(log(min(m,n))$，特判数组大小为(0,*)(1,*)(2,*)的情况，二分查找，注意奇怪的边界情况</p>
</li>
<li><p><a href="https://leetcode.com/problems/longest-palindromic-substring" target="_blank" rel="external">Longest Palindromic Substring</a></p>
<p>$O(n)$，强上manacher算法</p>
</li>
<li><p><a href="https://leetcode.com/problems/zigzag-conversion" target="_blank" rel="external">ZigZag Conversion</a></p>
<p>手动模拟一下“ZIGZAG”的样子，模拟过程</p>
</li>
<li><p><a href="https://leetcode.com/problems/reverse-integer" target="_blank" rel="external">Reverse Integer</a></p>
<p>按位取出，重新分配，注意溢出问题</p>
</li>
<li><p><a href="https://leetcode.com/problems/string-to-integer-atoi" target="_blank" rel="external">String to Integer (atoi)</a></p>
<p>按位取出，重新分配，注意符号和溢出问题</p>
</li>
<li><p><a href="https://leetcode.com/problems/palindrome-number" target="_blank" rel="external">Palindrome Number</a></p>
<p>$O(n)$，从两边向中间判断</p>
</li>
<li><p><a href="https://leetcode.com/problems/regular-expression-matching" target="_blank" rel="external">Regular Expression Matching</a></p>
<p>$O(mn)$，DP，按下一个是否为’*’分类讨论</p>
</li>
</ol>
<h2 id="11-20"><a href="#11-20" class="headerlink" title="11~20"></a>11~20</h2><ol>
<li><p><a href="https://leetcode.com/problems/container-with-most-water" target="_blank" rel="external">Container With Most Water</a></p>
<p>$O(n)$，two pointers，移动高度较小的指针，使结果尽量大。</p>
</li>
<li><p><a href="https://leetcode.com/problems/integer-to-roman" target="_blank" rel="external">Integer to Roman</a></p>
<p>模拟题，按照罗马数字的规则追加相应的字符串。</p>
</li>
<li><p><a href="https://leetcode.com/problems/roman-to-integer" target="_blank" rel="external">Roman to Integer</a></p>
<p>模拟题，按照罗马数字的规则加上相应的数字。</p>
</li>
<li><p><a href="https://leetcode.com/problems/longest-common-prefix" target="_blank" rel="external">Longest Common Prefix</a></p>
<p>模拟题，按照长度排序，然后搜索最短的字符串最大能匹配到所有的字符串的第多少个字符。</p>
</li>
<li><p><a href="https://leetcode.com/problems/3sum" target="_blank" rel="external">3Sum</a></p>
<p>$O(n^2)$，two pointers，枚举一个数，然后在后面的序列寻找满足的两个数，注意去重。</p>
</li>
<li><p><a href="https://leetcode.com/problems/3sum-closest" target="_blank" rel="external">3Sum Closest</a></p>
<p>与3Sum相同， 只是记录的时候判断并记录距离最小的值。</p>
</li>
<li><p><a href="https://leetcode.com/problems/letter-combinations-of-a-phone-number" target="_blank" rel="external">Letter Combinations of a Phone Number</a></p>
<p>模拟题，每次循环往上次生成的序列中的每个元素尾部追加相应字符。</p>
</li>
<li><p><a href="https://leetcode.com/problems/4sum" target="_blank" rel="external">4Sum</a></p>
<p>与3Sum相同，只是需要枚举两个值。</p>
</li>
<li><p><a href="https://leetcode.com/problems/remove-nth-node-from-end-of-list" target="_blank" rel="external">Remove Nth Node From End of List</a></p>
<p>简单的链表操作，注意删除首节点的情况。</p>
</li>
<li><p><a href="https://leetcode.com/problems/valid-parentheses" target="_blank" rel="external">Valid Parentheses</a></p>
<p>使用一个栈维护一下之前的左括号，按照右括号判断，若无对应的左括号则无法匹配。</p>
</li>
</ol>
<h2 id="21-30"><a href="#21-30" class="headerlink" title="21-30"></a>21-30</h2><p>to be continued…</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近无聊，刷了一批Leetcode水题，用简要题解记录一下做题过程，也小小帮助一下被坑所困的人。&lt;/p&gt;
    
    </summary>
    
    
      <category term="算法" scheme="http://qzwlecr.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
      <category term="leetcode" scheme="http://qzwlecr.github.io/tags/leetcode/"/>
    
  </entry>
  
  <entry>
    <title>NFC与门禁卡初探</title>
    <link href="http://qzwlecr.github.io/2017/05/17/NFC%E4%B8%8E%E9%97%A8%E7%A6%81%E5%8D%A1%E5%88%9D%E6%8E%A2/"/>
    <id>http://qzwlecr.github.io/2017/05/17/NFC与门禁卡初探/</id>
    <published>2017-05-17T03:36:21.000Z</published>
    <updated>2017-07-17T07:11:05.020Z</updated>
    
    <content type="html"><![CDATA[<p>开学之后，学校寝室和启明学院都开始使用了以校园卡为载体的门禁服务，只有刷指定人员的校园卡才能进入。我对其原理产生了好奇，就趁机进行了一些研究。</p>
<a id="more"></a>
<h1 id="了解NFC"><a href="#了解NFC" class="headerlink" title="了解NFC"></a>了解NFC</h1><p>NFC，near field communication(近场通信)，是一种短距离的高频无线通信技术，允许电子设备之间进行非接触式点对点数据传输，在十厘米内交换数据。2004年，诺基亚、飞利浦以及索尼三家公司建立了NFC forum，成为了NFC的开端。</p>
<p>NFC从其本质上来说，是一种RFID的演进技术，其于04年和05年发布了两个协议标准，分别是ISO/IEC 18092：2004和ISO/IEC 21481：2005。上述两个协议均源于更早的RFID协议 ISO/IEC 14443，即13.56MHz RFID协议标准。上述两个NFC协议推出的第二版分别是ISO/IEC 18092：2013(NFCIP-1)和ISO/IEC 21481：2012(NFCIP-2)。NFC向下兼容索尼的FeliCaTM标准以及飞利浦的MIFARE标准。</p>
<table>
<thead>
<tr>
<th>技术</th>
<th>协议</th>
<th>频率</th>
<th>传输距离</th>
<th>主动</th>
<th>被动</th>
<th>典型设备和应用</th>
</tr>
</thead>
<tbody>
<tr>
<td>NFC</td>
<td>ISO/IEC 18092<br>ISO/IEC 21481</td>
<td>13.56 MHz</td>
<td>10 cm</td>
<td>√</td>
<td>√</td>
<td>对等网络中的智能手机、平板电脑、便携式设备</td>
</tr>
<tr>
<td>免接触智能卡</td>
<td>ISO/IEC 14443</td>
<td>13.56 MHz</td>
<td>10 cm</td>
<td></td>
<td>√</td>
<td>票务、支付、门禁、护照等</td>
</tr>
<tr>
<td>RFID</td>
<td>ISO/IEC 18000</td>
<td>LF (120–150 KHz)<br>HF (13.56 MHz)<br>UHF (433–900 MHz)</td>
<td>&lt;40 m</td>
<td>√</td>
<td>√</td>
<td>标记和跟踪物品，适用于制造物流、零售等</td>
</tr>
</tbody>
</table>
<p>NFC的工作模式有三种，卡模拟模式（Card emulation mode）、点对点模式（P2P mode）和读/写模式（Reader/Writer mode）。</p>
<ul>
<li>在读/写模式中，NFC读/写器从NFC智能对象中读取数据，并根据这些信息操作。例如，采用支持NFC的手机，用户可以通过检索的URL自动联网、无需键入便可发送短信(SMS)文本、获取优惠券等，所有这些仅需触摸此对象的设备即可。</li>
<li>在点对点模式中，任何支持NFC功能的读/写器都可与另一个NFC读/写器进行通信并交换数据，与读/写模式具有同样的安全性、直观性和简单性等优势。在这种模式下，一个读/写器可作为一个标签，创建通信链路。例如，具有读/写器的两个设备(如智能电话)可以彼此通信。</li>
<li>卡模拟模式的NFC器件可以取代非接触式智能卡，使NFC器件能够用于现有的非接触式卡基础设施，进行票务、门禁、运输、收费站以及非接触式支付等操作。</li>
</ul>
<h1 id="复制流程"><a href="#复制流程" class="headerlink" title="复制流程"></a>复制流程</h1><h2 id="初步分析"><a href="#初步分析" class="headerlink" title="初步分析"></a>初步分析</h2><p>由于采集门禁卡信息时，只需要提供学号和姓名，以及卡编号，无需其他信息，故推测门禁只是简单读取卡的ID，而不会去解密其他信息，只需要使用卡模拟模式，简单地模拟一个ID相同的卡即可。在网上查阅资料可得知，门禁卡的工作原理大多如此。</p>
<h2 id="信息采集"><a href="#信息采集" class="headerlink" title="信息采集"></a>信息采集</h2><p>由于手头设备有限，只能用手机查看校园卡的ID信息。</p>
<p><a href="https://play.google.com/store/apps/details?id=com.wakdev.wdnfc" target="_blank" rel="external">NFC Tools下载地址</a><br><img src="/images/NFC-card/ID-information.jpg" alt=""></p>
<p>容易得到，Serial number处为形如<code>XX:XX:XX:XX</code>的ID（X为16进制数字）。这就是门禁所识别的ID。</p>
<h2 id="信息查询"><a href="#信息查询" class="headerlink" title="信息查询"></a>信息查询</h2><p>查阅相关资料可以得知，NFC的相应配置保存在<code>/system/etc/libnfc-nxp.conf</code>或<code>/system/etc/libnfc-brcm.conf</code>中，具体的配置取决于NFC芯片的类型。</p>
<p>手头有一部Nexus 6P，其芯片为NXP PN548，故阅读了<code>libnfc-nxp.conf</code>，通过注释从中发现了需要更改的配置。在文件的607行，有Core configuration settings中的<code>LA_NFCID1</code>，代表了手机NFC的NFCA-ID，这正是门禁系统能识别的ID。这里，33表示配置的类型，04表示后面所跟的配置字节数，后面的四个字节为数据。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">###############################################################################</div><div class="line"># Core configuration settings</div><div class="line"># It includes</div><div class="line"># 18        - Poll Mode NFC-F:   PF_BIT_RATE</div><div class="line"># 21        - Poll Mode ISO-DEP: PI_BIT_RATE</div><div class="line"># 28        - Poll Mode NFC-DEP: PN_NFC_DEP_SPEED</div><div class="line"># 30        - Lis. Mode NFC-A:   LA_BIT_FRAME_SDD</div><div class="line"># 31        - Lis. Mode NFC-A:   LA_PLATFORM_CONFIG</div><div class="line"># 33        - Lis. Mode NFC-A:   LA_NFCID1</div><div class="line"># 50        - Lis. Mode NFC-F:   LF_PROTOCOL_TYPE</div><div class="line"># 54        - Lis. Mode NFC-F:   LF_CON_BITR_F</div><div class="line"># 5B        - Lis. Mode ISO-DEP: LI_BIT_RATE</div><div class="line"># 60        - Lis. Mode NFC-DEP: LN_WT</div><div class="line"># 80        - Other Param.:      RF_FIELD_INFO</div><div class="line"># 81        - Other Param.:      RF_NFCEE_ACTION</div><div class="line"># 82        - Other Param.:      NFCDEP_OP</div><div class="line">NXP_CORE_CONF=&#123;20, 02, 2B, 0D,</div><div class="line">        18, 01, 01,</div><div class="line">        21, 01, 00,</div><div class="line">        28, 01, 00,</div><div class="line">        30, 01, 08,</div><div class="line">        31, 01, 03,</div><div class="line">        33, 04, 00, 00, 00, 00,</div><div class="line">        50, 01, 02,</div><div class="line">        54, 01, 06,</div><div class="line">        5B, 01, 00,</div><div class="line">        60, 01, 0E,</div><div class="line">        80, 01, 01,</div><div class="line">        81, 01, 01,</div><div class="line">        82, 01, 0E</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="信息修改"><a href="#信息修改" class="headerlink" title="信息修改"></a>信息修改</h2><p>将上面获取到的ID插入配置文件中，重启手机NFC，即可完成修改。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/system/bin/sh</span></div><div class="line">sed -i <span class="string">'607s/^.*$/        33, 04, XX, XX, XX, XX,/'</span> /etc/libnfc-nxp.conf</div></pre></td></tr></table></figure>
<h2 id="批量修改"><a href="#批量修改" class="headerlink" title="批量修改"></a>批量修改</h2><p>尝试着写了批量修改的脚本，以完成某些特殊要求，但是由于安卓系统本身的限制，无法做到自动重启NFC，贴代码仅供参考。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/system/bin/sh</span></div><div class="line">setenforce 0</div><div class="line"><span class="built_in">echo</span> <span class="string">"SElinux disabled"</span></div><div class="line"><span class="comment">#disable SElinux</span></div><div class="line">mount -o rw,remount /system</div><div class="line"><span class="built_in">echo</span> <span class="string">"nfc disabled"</span></div><div class="line">service call nfc 5</div><div class="line">sleep 1</div><div class="line"><span class="comment">#first person</span></div><div class="line">sed -i <span class="string">'607s/^.*$/        33, 04, XX, XX, XX, XX,/'</span> /etc/libnfc-nxp.conf</div><div class="line">sleep 1</div><div class="line">service call nfc 6</div><div class="line"><span class="built_in">echo</span> <span class="string">"nfc enabled"</span></div><div class="line">sleep 5</div><div class="line">service call nfc 5</div><div class="line"><span class="built_in">echo</span> <span class="string">"nfc disabled"</span></div><div class="line">sleep 1</div><div class="line"><span class="comment">#second person</span></div><div class="line">sed -i <span class="string">'607s/^.*$/        33, 04, XX, XX, XX, XX,/'</span> /etc/libnfc-nxp.conf</div><div class="line">service call nfc 6</div><div class="line"><span class="built_in">echo</span> <span class="string">"nfc enabled"</span></div><div class="line">sleep 1</div><div class="line">setenforce 1</div></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>门禁使用易于复制的射频卡ID检测是极为不安全的，外来人员只需要注意到这一点就可以轻松地进入宿舍，同时，此功能还可以用来体育打卡、进入图书馆等，需要慎加利用。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;开学之后，学校寝室和启明学院都开始使用了以校园卡为载体的门禁服务，只有刷指定人员的校园卡才能进入。我对其原理产生了好奇，就趁机进行了一些研究。&lt;/p&gt;
    
    </summary>
    
    
      <category term="NFC" scheme="http://qzwlecr.github.io/tags/NFC/"/>
    
      <category term="hack" scheme="http://qzwlecr.github.io/tags/hack/"/>
    
  </entry>
  
</feed>
